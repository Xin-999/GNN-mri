# %%
# #!/usr/bin/env python3
"""
plot_corr_matrix.py

Load a Shen-268 ROI time-series .txt file and plot its ROI×ROI correlation matrix.
"""

import argparse
from pathlib import Path
import matplotlib
matplotlib.use("Agg")  
import numpy as np
import matplotlib.pyplot as plt
from sklearn.covariance import ledoit_wolf

TS_PATH = r"c:\Users\USER\Documents\InternQX\Movie-HCP_Brain_Graph-master\data\all_shen_roi_ts\100610_MOVIE2_7T_AP_shen268_roi_ts_gsr.txt"

def cov2corr(covariance: np.ndarray) -> np.ndarray:
    """
    Convert covariance matrix to correlation matrix.
    Same as in step1_compute_ldw.py.
    """
    v = np.sqrt(np.diag(covariance))
    outer_v = np.outer(v, v)
    corr = covariance / outer_v
    corr[covariance == 0] = 0
    return corr


def compute_corr(ts: np.ndarray, method: str = "pearson") -> np.ndarray:
    """
    Compute ROI×ROI correlation from time-series.

    ts: array of shape (T, N_ROI)
    method: "pearson" or "ldw" (Ledoit–Wolf covariance → correlation)
    """
    if ts.ndim != 2:
        raise ValueError(f"Expected 2D array (T, N_ROI), got shape {ts.shape}")

    if method == "pearson":
        # np.corrcoef expects variables in rows if rowvar=True
        # Our ts shape is (T, N_ROI) → set rowvar=False
        corr = np.corrcoef(ts, rowvar=False)
    elif method == "ldw":
        cov, _ = ledoit_wolf(ts, assume_centered=False)
        corr = cov2corr(cov)
    else:
        raise ValueError(f"Unknown method: {method}")

    return corr


def plot_corr(corr: np.ndarray, title: str = ""):
    """
    Plot a correlation matrix using matplotlib.
    """
    fig, ax = plt.subplots(figsize=(6, 5))

    im = ax.imshow(corr, vmin=-1, vmax=1)

    ax.set_title(title if title else "ROI Correlation Matrix")
    ax.set_xlabel("ROI index")
    ax.set_ylabel("ROI index")

    # Optional: show fewer ticks to avoid clutter
    n_roi = corr.shape[0]
    tick_step = max(1, n_roi // 10)
    ticks = np.arange(0, n_roi, tick_step)
    ax.set_xticks(ticks)
    ax.set_yticks(ticks)

    cbar = fig.colorbar(im, ax=ax)
    cbar.set_label("Correlation")

    fig.tight_layout()
    plt.show()


def main():
    parser = argparse.ArgumentParser(
        description="Plot ROI×ROI correlation matrix from Shen-268 time-series .txt file."
    )
    parser.add_argument(
        "ts_path",
        type=str,
        help="Path to the time-series .txt file (T x 268).",
    )
    parser.add_argument(
        "--method",
        choices=["pearson", "ldw"],
        default="pearson",
        help="Correlation method: 'pearson' or 'ldw' (Ledoit–Wolf covariance → correlation).",
    )

    args = parser.parse_args()
    ts_path = Path(args.ts_path)

    if not ts_path.exists():
        raise FileNotFoundError(f"File not found: {ts_path}")

    print(f"Loading time-series from {ts_path} ...")
    ts = np.loadtxt(ts_path)

    # If the file accidentally comes as (268, T), transpose
    if ts.shape[0] == 268 and ts.shape[1] != 268:
        ts = ts.T

    print(f"Time-series shape: {ts.shape} (T x N_ROI)")

    corr = compute_corr(ts, method=args.method)
    print("Correlation matrix shape:", corr.shape)

    title = f"{ts_path.stem} ({args.method} correlation)"
    plot_corr(corr, title=title)


if __name__ == "__main__":
    main()

# %%

